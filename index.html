<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>AI Chat</title>
    <style>
        /* iOS Design System */
        :root {
            --bg: #F2F2F7;
            --blue: #007AFF;
            --gray-bubble: #E9E9EB;
            --input-area: #F8F8F8;
            --border: #C6C6C8;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        /* Chat Area */
        #chat {
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px;
            padding-bottom: 90px;
        }
        .msg {
            max-width: 75%; padding: 10px 14px; font-size: 16px; line-height: 1.4; border-radius: 18px;
            position: relative; word-wrap: break-word; animation: popIn 0.2s ease-out;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .msg.bot { background: var(--gray-bubble); color: #000; align-self: flex-start; border-bottom-left-radius: 4px; }
        .msg.user { background: var(--blue); color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg img { max-width: 100%; border-radius: 12px; margin-bottom: 5px; display: block; }

        /* Input Area */
        #footer {
            position: fixed; bottom: 0; width: 100%; background: rgba(248,248,248,0.95);
            backdrop-filter: blur(10px); border-top: 0.5px solid var(--border);
            padding: 10px 15px; box-sizing: border-box; display: flex; align-items: flex-end; gap: 10px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        #inp-wrap {
            flex: 1; background: #fff; border: 1px solid var(--border); border-radius: 20px;
            padding: 8px 12px; display: flex; align-items: center; min-height: 36px;
        }
        textarea {
            width: 100%; border: none; outline: none; resize: none; font-family: inherit; font-size: 16px;
            max-height: 100px; padding: 0; margin: 0; background: transparent;
        }
        button { background: none; border: none; cursor: pointer; padding: 0; color: var(--blue); }
        button:disabled { color: #aaa; }
        
        /* Preview */
        #preview {
            position: absolute; bottom: 70px; left: 15px; background: #fff; padding: 4px;
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none;
        }
        #preview img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
        #preview span {
            position: absolute; top: -6px; right: -6px; background: #8e8e93; color: #fff;
            width: 20px; height: 20px; border-radius: 50%; text-align: center; line-height: 18px;
            font-size: 14px; cursor: pointer; border: 2px solid #fff;
        }
    </style>
</head>
<body>
    <div id="chat">
        <div class="msg bot">Привет! Я готов работать.</div>
    </div>

    <div id="preview">
        <span onclick="clearFile()">×</span>
        <img id="prev-img" src="">
    </div>

    <div id="footer">
        <button onclick="document.getElementById('file').click()">
            <svg width="28" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        </button>
        <input type="file" id="file" accept="image/*" hidden onchange="showFile(this)">
        
        <div id="inp-wrap">
            <textarea id="txt" rows="1" placeholder="Сообщение..." oninput="autoResize(this)"></textarea>
        </div>
        
        <button onclick="send()" id="send-btn">
            <svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        let fileObj = null;

        function autoResize(el) {
            el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px';
        }

        function showFile(input) {
            if (input.files && input.files[0]) {
                fileObj = input.files[0];
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('prev-img').src = e.target.result;
                    document.getElementById('preview').style.display = 'block';
                };
                reader.readAsDataURL(fileObj);
            }
        }

        function clearFile() {
            fileObj = null; document.getElementById('file').value = '';
            document.getElementById('preview').style.display = 'none';
        }

        function addMsg(text, type, img = null) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            let html = img ? `<img src="${img}">` : '';
            // Простой markdown (жирный) и переносы
            html += text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            div.innerHTML = html;
            document.getElementById('chat').appendChild(div);
            window.scrollTo(0, document.body.scrollHeight);
            return div;
        }

        async function send() {
            const txt = document.getElementById('txt');
            const val = txt.value.trim();
            if (!val && !fileObj) return;

            let imgSrc = fileObj ? document.getElementById('prev-img').src : null;
            addMsg(val, 'user', imgSrc);
            
            const formData = new FormData();
            formData.append('message', val);
            if (fileObj) formData.append('image', fileObj);

            txt.value = ''; txt.style.height = 'auto'; clearFile();
            const botMsg = addMsg('...', 'bot'); // Плейсхолдер

            try {
                const res = await fetch('/api/chat', { method: 'POST', body: formData });
                const reader = res.body.getReader();
                const dec = new TextDecoder();
                let full = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    full += dec.decode(value);
                    botMsg.innerHTML = full.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
                    window.scrollTo(0, document.body.scrollHeight);
                }
            } catch (e) { botMsg.innerText = "Ошибка: " + e; }
        }
    </script>
</body>
</html>