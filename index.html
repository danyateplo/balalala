<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>Gemini 2.0</title>
    <style>
        :root {
            --bg: #131314;
            --surface: #1E1F20;
            --text: #E3E3E3;
            --user-bubble: #0A84FF;
            --bot-bubble: #303132;
            --input-bg: #1E1F20;
        }
        body {
            font-family: 'Google Sans', Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; display: flex; flex-direction: column; height: 100vh;
        }
        /* Header */
        header {
            padding: 15px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid #333; font-size: 18px; font-weight: 500;
        }
        /* Chat Area */
        #chat {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px;
            padding-bottom: 120px;
        }
        .msg {
            max-width: 85%; padding: 12px 16px; font-size: 15px; line-height: 1.5;
            position: relative; animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .msg.bot {
            align-self: flex-start; background: var(--bot-bubble); color: var(--text);
            border-radius: 18px 18px 18px 4px;
        }
        .msg.user {
            align-self: flex-end; background: var(--user-bubble); color: white;
            border-radius: 18px 18px 4px 18px;
        }
        .msg img { max-width: 100%; border-radius: 10px; margin-bottom: 8px; }

        /* Floating Input Area */
        #input-container {
            position: fixed; bottom: 20px; left: 10px; right: 10px;
            background: var(--surface); border-radius: 28px;
            padding: 8px 16px; display: flex; flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        #preview-area { display: none; padding: 10px 0; position: relative; }
        #preview-area img { width: 60px; height: 60px; object-fit: cover; border-radius: 10px; border: 1px solid #444; }
        #preview-area span {
            position: absolute; top: 5px; left: 50px; background: #444; color: white;
            width: 18px; height: 18px; border-radius: 50%; text-align: center; font-size: 12px; cursor: pointer;
        }

        #input-row { display: flex; align-items: center; gap: 12px; min-height: 48px; }
        
        textarea {
            flex: 1; background: transparent; border: none; outline: none;
            color: var(--text); font-size: 16px; resize: none; max-height: 150px;
        }
        .icon-btn { color: #C4C7C5; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #send-btn { color: var(--user-bubble); }

        .welcome-text { text-align: center; margin-top: 40px; color: #8e8e93; }
        .welcome-text h1 { color: white; font-size: 24px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <header>
        <span>☰ &nbsp; Gemini</span>
        <div id="user-avatar" style="width:30px; height:30px; background:#444; border-radius:50%"></div>
    </header>

    <div id="chat">
        <div class="welcome-text">
            <h1 id="greeting">Здравствуйте!</h1>
            <p>С чего начнем?</p>
        </div>
    </div>

    <div id="input-container">
        <div id="preview-area">
            <span onclick="clearFile()">×</span>
            <img id="prev-img" src="">
        </div>
        <div id="input-row">
            <label class="icon-btn">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                <input type="file" id="file" hidden accept="image/*" onchange="showFile(this)">
            </label>
            <textarea id="txt" rows="1" placeholder="Спросите Gemini" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
            <div class="icon-btn" id="send-btn" onclick="send()">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        if(tg.initDataUnsafe?.user?.first_name) {
            document.getElementById('greeting').innerText = `Здравствуйте, ${tg.initDataUnsafe.user.first_name}!`;
        }

        let fileObj = null;

        function showFile(input) {
            if (input.files && input.files[0]) {
                fileObj = input.files[0];
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('prev-img').src = e.target.result;
                    document.getElementById('preview-area').style.display = 'block';
                };
                reader.readAsDataURL(fileObj);
            }
        }

        function clearFile() {
            fileObj = null;
            document.getElementById('file').value = '';
            document.getElementById('preview-area').style.display = 'none';
        }

        function addMsg(text, type, img = null) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            let html = img ? `<img src="${img}">` : '';
            html += `<span>${text.replace(/\n/g, '<br>')}</span>`;
            div.innerHTML = html;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
            return div;
        }

        async function send() {
            const txt = document.getElementById('txt');
            const val = txt.value.trim();
            if (!val && !fileObj) return;

            const userImg = fileObj ? document.getElementById('prev-img').src : null;
            addMsg(val, 'user', userImg);
            
            const formData = new FormData();
            formData.append('message', val);
            if (fileObj) formData.append('image', fileObj);

            txt.value = ''; txt.style.height = 'auto'; clearFile();
            const botMsg = addMsg('...', 'bot');

            try {
                const res = await fetch('/api/chat', { method: 'POST', body: formData });
                const reader = res.body.getReader();
                const dec = new TextDecoder();
                let full = '';
                botMsg.innerHTML = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    full += dec.decode(value);
                    botMsg.innerHTML = full.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
                    document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
                }
            } catch (e) { botMsg.innerText = "Ошибка соединения"; }
        }
    </script>
</body>
</html>
