<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>Gemini AI</title>
    <style>
        :root {
            --bg: #131314;
            --surface: #1E1F20;
            --text-main: #E3E3E3;
            --text-sec: #9AA0A6;
            --user-blue: #0A84FF;
            --bot-gray: #2A2B2F;
        }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); color: var(--text-main);
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        header {
            padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;
            background: var(--bg); border-bottom: 1px solid #333; z-index: 10;
        }
        #chat {
            flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px;
            scroll-behavior: smooth;
        }
        /* Группировка для выравнивания */
        .msg-wrapper { display: flex; width: 100%; margin-bottom: 4px; }
        .msg-wrapper.user { justify-content: flex-end; }
        .msg-wrapper.bot { justify-content: flex-start; }

        .bubble {
            max-width: 80%; padding: 12px 16px; border-radius: 20px;
            font-size: 15px; line-height: 1.5; word-wrap: break-word;
        }
        .user .bubble {
            background-color: var(--user-blue); color: #fff;
            border-bottom-right-radius: 4px;
        }
        .bot .bubble {
            background-color: var(--bot-gray); color: var(--text-main);
            border-bottom-left-radius: 4px;
        }
        .bubble img { max-width: 100%; border-radius: 12px; margin-bottom: 8px; display: block; }

        /* Welcome Screen */
        .welcome { text-align: center; margin-top: 60px; }
        .welcome h1 { font-size: 28px; font-weight: 400; margin-bottom: 10px; }
        .welcome p { color: var(--text-sec); font-size: 16px; }

        /* Input Area */
        #controls {
            padding: 12px 16px; background: var(--bg); padding-bottom: max(16px, env(safe-area-inset-bottom));
        }
        #input-panel {
            background: var(--surface); border-radius: 28px; padding: 6px 14px;
            display: flex; flex-direction: column; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        #preview {
            display: none; padding: 10px; position: relative; align-self: flex-start;
        }
        #preview img { width: 64px; height: 64px; border-radius: 12px; object-fit: cover; border: 1px solid #444; }
        #preview .close {
            position: absolute; top: 0; right: 0; background: #555; color: #fff;
            width: 20px; height: 20px; border-radius: 50%; text-align: center; font-size: 14px; cursor: pointer;
        }
        .row { display: flex; align-items: center; gap: 10px; min-height: 44px; }
        textarea {
            flex: 1; background: transparent; border: none; outline: none;
            color: var(--text-main); font-size: 16px; resize: none; max-height: 120px;
        }
        .btn { color: var(--text-sec); cursor: pointer; display: flex; align-items: center; transition: 0.2s; }
        .btn:hover { color: var(--text-main); }
        #send { color: var(--user-blue); opacity: 0.5; }
    </style>
</head>
<body>

    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:20px; opacity:0.7">☰</span>
            <span style="font-weight:500; font-size:18px;">Gemini</span>
        </div>
        <div style="width:32px; height:32px; background:#3c4043; border-radius:50%; overflow:hidden;">
            <img id="u-pic" src="" style="width:100%; display:none">
        </div>
    </header>

    <div id="chat">
        <div class="welcome" id="welcome">
            <h1 id="user-name">Здравствуйте!</h1>
            <p>С чего начнем?</p>
        </div>
    </div>

    <div id="controls">
        <div id="input-panel">
            <div id="preview">
                <div class="close" onclick="removeFile()">×</div>
                <img id="p-img" src="">
            </div>
            <div class="row">
                <label class="btn">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                    <input type="file" id="f-inp" hidden accept="image/*" onchange="handleFile(this)">
                </label>
                <textarea id="msg-inp" rows="1" placeholder="Спросите Gemini" oninput="checkInput()"></textarea>
                <div class="btn" id="send" onclick="sendMsg()">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        if(tg.initDataUnsafe?.user) {
            const u = tg.initDataUnsafe.user;
            document.getElementById('user-name').innerText = `Здравствуйте, ${u.first_name}!`;
            if(u.photo_url) {
                const pic = document.getElementById('u-pic');
                pic.src = u.photo_url; pic.style.display = 'block';
            }
        }

        let currentFile = null;
        const inp = document.getElementById('msg-inp');
        const sendBtn = document.getElementById('send');

        function checkInput() {
            inp.style.height = 'auto';
            inp.style.height = inp.scrollHeight + 'px';
            sendBtn.style.opacity = (inp.value.trim() || currentFile) ? "1" : "0.5";
        }

        function handleFile(input) {
            if (input.files[0]) {
                currentFile = input.files[0];
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('p-img').src = e.target.result;
                    document.getElementById('preview').style.display = 'block';
                    checkInput();
                };
                reader.readAsDataURL(currentFile);
            }
        }

        function removeFile() {
            currentFile = null;
            document.getElementById('f-inp').value = '';
            document.getElementById('preview').style.display = 'none';
            checkInput();
        }

        function pushMsg(text, isUser, imgSrc = null) {
            document.getElementById('welcome').style.display = 'none';
            const wrap = document.createElement('div');
            wrap.className = `msg-wrapper ${isUser ? 'user' : 'bot'}`;
            
            let content = imgSrc ? `<img src="${imgSrc}">` : '';
            content += `<span>${text.replace(/\n/g, '<br>')}</span>`;
            
            wrap.innerHTML = `<div class="bubble">${content}</div>`;
            document.getElementById('chat').appendChild(wrap);
            document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
            return wrap.querySelector('span');
        }

        async function sendMsg() {
            const text = inp.value.trim();
            if (!text && !currentFile) return;

            const uImg = currentFile ? document.getElementById('p-img').src : null;
            pushMsg(text, true, uImg);

            const fd = new FormData();
            fd.append('message', text);
            if (currentFile) fd.append('image', currentFile);

            inp.value = ''; inp.style.height = 'auto'; removeFile();
            const botSpan = pushMsg('...', false);

            try {
                const res = await fetch('/api/chat', { method: 'POST', body: fd });
                const reader = res.body.getReader();
                const dec = new TextDecoder();
                let full = '';
                botSpan.innerHTML = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    full += dec.decode(value);
                    botSpan.innerHTML = full.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
                    document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
                }
            } catch (e) { botSpan.innerText = "⚠️ Ошибка сети"; }
        }
    </script>
</body>
</html>
